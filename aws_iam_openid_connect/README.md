# AWS IAM OpenID Connect Provider Module

This module creates AWS IAM OpenID Connect Provider.

**NOTE!** Requires network access to the client URL to retrieve the server TLS certificate details.

### Use case - GitLab:
Here is a GitLab example of configuring GitLab CI to 
[Configure OpenID Connect in AWS to retrieve temporary credentials](https://docs.gitlab.com/ee/ci/cloud_services/aws/):

1. Set the `AWS_ROLE_ARN` variable in the GitLab Project (Settings -> CI). This value is generated as output after terraform apply is run.
2. Set the `AWS_DEFAULT_REGION` variable in the GitLab Project (Settings -> CI).
4. `MY_OIDC_TOKEN` is an `client_id`.
```yaml
assume-role-example:
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  id_tokens:
    MY_OIDC_TOKEN:
      aud: ${CLIENT_ID}
  variables:
    # https://docs.aws.amazon.com/cli/latest/topic/config-vars.html#assume-role-with-web-identity
    AWS_WEB_IDENTITY_TOKEN_FILE: /tmp/web_identity_token
  before_script:
    - echo "${MY_OIDC_TOKEN}" > ${AWS_WEB_IDENTITY_TOKEN_FILE}
  script:
    - aws sts get-caller-identity
    - aws s3 ls
    - aws ec2 describe-instances
```

<!-- Next block is generated by terraform-docs following .terraform-docs.yml config -->
<!-- BEGIN_TF_DOCS -->
## Example

```hcl
# main.tf
module "openid_connect" {
  source = "../../../../modules/aws_iam_openid_connect"

  client_url                  = "https://example.gitlab.com"
  client_id                   = "example.gitlab.com"
  client_tls_sha1_fingerprint = data.tls_certificate.client.certificates[0].sha1_fingerprint
  match_values                = [
    "https://example.gitlab.com/frontend-group/fe-webserver:ref_type:branch:ref:develop"
  ]
}

# https://registry.terraform.io/providers/hashicorp/tls/latest/docs/data-sources/certificate
data "tls_certificate" "client" {
  url = "tls://example.gitlab.com:443"
}
```

## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | < 2.0.0, >= 1.6.6 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | < 6.0, >= 5.22 |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_client_url"></a> [client\_url](#input\_client\_url) | Client URL. For example: `https://example.com` | `string` | n/a | yes |
| <a name="input_client_id"></a> [client\_id](#input\_client\_id) | Client ID that will be registered and used to identify an application. For example: `api.example.com` | `string` | n/a | yes |
| <a name="input_client_tls_sha1_fingerprint"></a> [client\_tls\_sha1\_fingerprint](#input\_client\_tls\_sha1\_fingerprint) | Client URL Certificate SHA1 Fingerprint<br><br>**NOTE!** Must contain 40 alphanumeric characters (SHA1 HASH) without `:`.<br><br>`9E:11:A4:22:92:70:33:49:26:AB:7F:3B:02:CC:2D:A3:00:AB:72:XX`  => `"9E11A4229270334926AB7F3B02CC2DA300AB72XX"` | `string` | `""` | no |
| <a name="input_match_field"></a> [match\_field](#input\_match\_field) | Match Field.<br><br>Available values:<br>  - `"sub"` (Subject)<br>  - `"aud"` (Audience) | `string` | `"sub"` | no |
| <a name="input_match_values"></a> [match\_values](#input\_match\_values) | Value of the Subject Match Field.<br><br>For example, for GitLab:<br>  - specific project, main branch: `"project_path:mygroup/myproject:ref_type:branch:ref:main"`<br>  - all projects under a group: `"project_path:mygroup/*:ref_type:branch:ref:main"` | `list(string)` | `[]` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_client_role_arn"></a> [client\_role\_arn](#output\_client\_role\_arn) | Client Role ARN |

## Resources

| Name | Type |
|------|------|
| [aws_iam_openid_connect_provider.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_openid_connect_provider) | resource |
| [aws_iam_role.client_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_policy_document.assume-role-policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
<!-- END_TF_DOCS -->